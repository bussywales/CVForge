import { NextResponse } from "next/server";
import { z } from "zod";
import { createServerClient } from "@/lib/supabase/server";
import { applyRequestIdHeaders, withRequestIdHeaders, jsonError } from "@/lib/observability/request-id";
import { processMonetisationLog } from "@/lib/monetisation-log";
import { checkRateLimit } from "@/lib/rate-limit";
import { getRateLimitBudget } from "@/lib/rate-limit-budgets";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

const allowedEvents = [
  "gate_shown",
  "gate_blocked",
  "billing_clicked",
  "billing_viewed",
  "billing_return",
  "billing_success_banner_view",
  "billing_success_banner_resume_click",
  "billing_success_banner_dismiss",
  "resume_completed",
  "resume_next_step_click",
  "pack_recommended",
  "checkout_started",
  "checkout_redirect_failed",
  "checkout_retry_click",
  "checkout_try_again",
  "checkout_open_new_tab",
  "checkout_help_open",
  "checkout_help_click",
  "checkout_start_failed",
  "checkout_return_view",
  "checkout_return_dismiss",
  "checkout_cancel_view",
  "checkout_failed_view",
  "checkout_redirect_blocked",
  "checkout_success",
  "autopack_generate_completed",
  "interview_pack_export_completed",
  "application_kit_download_completed",
  "answer_pack_generate_completed",
  "completion_watchdog_view",
  "completion_watchdog_back_click",
  "completion_watchdog_mark_done",
  "completion_watchdog_dismiss",
  "credits_idle_nudge_view",
  "credits_idle_nudge_click",
  "credits_idle_nudge_dismiss",
  "billing_sub_reco_view",
  "billing_sub_reco_click",
  "billing_sub_reco_checkout_started",
  "billing_sub_reco_checkout_failed",
  "sub_nudge_view",
  "sub_nudge_click_start",
  "sub_nudge_click_manage",
  "sub_gate_upsell_view",
  "sub_gate_upsell_click",
  "sub_home_view",
  "sub_home_cta_click",
  "sub_low_activity_view",
  "sub_low_activity_dismiss",
  "sub_save_offer_open",
  "sub_save_offer_choose_plan",
  "sub_save_offer_keep",
  "sub_save_offer_go_to_stripe",
  "sub_save_offer_view",
  "sub_save_offer_dismiss",
  "sub_save_offer_primary_click",
  "sub_save_offer_secondary_click",
  "sub_save_offer_topups_click",
  "sub_save_offer_portal_open",
  "sub_save_offer_return",
  "sub_save_offer_outcome_active",
  "sub_save_offer_outcome_inactive",
  "sub_portal_return_view",
  "sub_portal_return_dismiss",
  "sub_portal_return_keep_momentum",
  "sub_portal_return_still_cancel",
  "sub_portal_return_reopen_portal",
  "sub_post_purchase_tip_view",
  "sub_post_purchase_tip_click",
  "sub_recovery_upsell_view",
  "sub_recovery_upsell_click",
  "sub_gate_view",
  "sub_gate_click_subscribe",
  "sub_gate_not_now",
  "sub_gate_checkout_start_failed",
  "sub_gate_plan_unavailable",
  "sub_selector_view",
  "sub_selector_change_plan",
  "sub_selector_start_checkout",
  "sub_selector_plan_unavailable",
  "sub_selector_manage_portal_click",
  "sub_reco_reason_impression",
  "sub_manage_view",
  "sub_upgrade_click",
  "sub_downgrade_click",
  "billing_portal_click",
  "billing_portal_redirected",
  "billing_portal_error",
  "billing_status_view",
  "billing_portal_error_banner_view",
  "billing_portal_error_banner_dismiss",
  "billing_portal_error_retry_click",
  "billing_support_snippet_copy",
  "billing_reconcile_hint_view",
  "billing_reconcile_hint_refresh_click",
  "billing_reconcile_hint_support_click",
  "billing_webhook_badge_view",
  "billing_webhook_badge_cta_click",
  "billing_recheck_confidence_returned",
  "billing_webhook_badge_view_v2",
  "billing_webhook_support_cta_click",
  "billing_correlation_confidence_view",
  "billing_recheck_confidence_update",
  "billing_webhook_badge_view",
  "billing_webhook_badge_delayed_snippet_copy",
  "billing_webhook_badge_state_change",
  "billing_webhook_signal_view",
  "billing_webhook_trace_copy",
  "billing_recheck_webhook_receipt_view",
  "billing_timeline_view",
  "billing_trace_view",
  "billing_webhook_health_view",
  "billing_recheck_click",
  "billing_recheck_rate_limited",
  "billing_recheck_result",
  "billing_trace_snippet_copy",
  "billing_correlation_view",
  "billing_correlation_recheck_click",
  "billing_delay_classified",
  "billing_delay_playbook_view",
  "billing_delay_playbook_cta_click",
  "billing_help_prompt_view",
  "billing_help_prompt_yes",
  "billing_help_prompt_no",
  "billing_help_prompt_copy_snippet",
  "billing_help_prompt_retry_portal_click",
  "billing_help_prompt_dismiss",
  "billing_credit_delay_view",
  "billing_credit_delay_refresh_click",
  "billing_timeline_support_snippet_copy",
  "ops_support_portal_open_click",
  "activation_cta_click",
  "activation_view",
  "activation_step_click",
  "activation_primary_cta_click",
  "activation_model_error",
  "activation_completed",
  "activation_skip_week",
  "activation_funnel_view",
  "activation_funnel_export",
  "activation_first_application",
  "activation_first_outreach",
  "activation_first_followup",
  "activation_first_outcome",
  "keep_momentum_view",
  "keep_momentum_cta_click",
  "keep_momentum_secondary_click",
  "keep_momentum_skip_week",
  "keep_momentum_model_error",
  "sub_portal_opened",
  "sub_portal_open_failed",
  "sub_change_returned",
  "weekly_coach_view",
  "weekly_coach_action_click",
  "weekly_coach_action_log",
  "weekly_coach_targets_view",
  "weekly_coach_mark_done",
  "weekly_coach_undo",
  "weekly_coach_week_complete_view",
  "weekly_coach_add_one_more",
  "weekly_coach_leave_it",
  "weekly_review_view",
  "weekly_review_log_outcomes_click",
  "weekly_review_not_now",
  "weekly_streak_view",
  "weekly_review_examples_open",
  "weekly_review_example_click",
  "weekly_review_outcome_inline_open",
  "weekly_review_outcome_inline_save_success",
  "weekly_review_outcome_inline_save_fail",
  "streak_saver_view",
  "streak_saver_dismiss",
  "streak_saver_cta_click",
  "streak_saver_billing_banner_view",
  "streak_saver_billing_banner_dismiss",
  "streak_saver_plan_selected",
  "streak_saver_checkout_start",
  "streak_saver_checkout_start_failed",
  "streak_saver_checkout_return",
  "streak_saver_sub_active_detected",
  "intent_tile_view",
  "intent_tile_click_plan",
  "intent_tile_dismiss",
  "intent_tile_expand_why",
  "intent_billing_banner_view",
  "intent_billing_banner_dismiss",
  "sub_post_purchase_view",
  "sub_post_purchase_auto_redirect",
  "sub_post_purchase_resume_click",
  "sub_post_purchase_not_now",
  "sub_completion_nudge_view",
  "sub_completion_nudge_completed",
  "sub_completion_nudge_dismiss",
  "billing_compare_view",
  "billing_compare_choice_subscribe",
  "billing_compare_choice_topup",
  "gate_compare_view",
  "gate_compare_choice_subscribe",
  "gate_compare_choice_topup",
  "billing_plan_unavailable",
  "sub_cancel_reason_view",
  "sub_cancel_reason_select",
  "sub_cancel_reason_continue_portal",
  "sub_cancel_reason_dismiss",
  "sub_cancel_pause_hint_click",
  "cancel_deflect_view",
  "cancel_deflect_reason_select",
  "cancel_deflect_offer_shown",
  "cancel_deflect_save_click",
  "cancel_deflect_continue_to_stripe",
  "cancel_deflect_not_now",
  "cancel_deflect_dismiss",
  "resume_banner_shown",
  "resume_clicked",
  "resume_dismissed",
  "autopack_generated",
  "billing_pack_unavailable",
  "interview_focus_view",
  "interview_focus_open_click",
  "interview_focus_mark_done",
  "interview_focus_undo",
  "interview_focus_session_complete",
  "interview_focus_add_one_more",
  "interview_focus_leave_it",
  "interview_session_view",
  "interview_session_start",
  "interview_session_mark_ready",
  "interview_session_undo",
  "interview_session_complete",
  "interview_session_copy_all",
  "outreach_panel_view",
  "outreach_copy_click",
  "outreach_log_sent",
  "outreach_schedule_next",
  "outreach_queue_view",
  "outreach_queue_copy_log_open",
  "outreach_queue_logged",
  "outreach_open_gmail_click",
  "outreach_open_linkedin_click",
  "outreach_mailto_fallback_copy",
  "outreach_contact_missing_block",
  "outreach_contact_save",
  "outreach_contact_edit",
  "outreach_mailto_long_copy",
  "outreach_send_blocked_no_contact",
  "outreach_triage_view",
  "outreach_triage_select",
  "outreach_next_move_view",
  "outreach_next_move_click",
  "outreach_outcome_quicklog_success",
  "outreach_outcome_quicklog_fail",
  "outreach_variant_view",
  "outreach_variant_select",
  "outreach_variant_copy",
  "outreach_send_gmail",
  "outreach_send_linkedin",
  "outreach_quality_shown",
  "outreach_insight_view",
  "outreach_insight_click",
  "offer_pack_view",
  "offer_pack_save",
  "offer_pack_copy_script",
  "offer_pack_copy_decision",
  "offer_pack_set_counter",
  "offer_pack_missing_data_prompt",
  "offer_decision_view",
  "offer_decision_save",
  "offer_decision_undo",
  "offer_decision_outcome_autologged",
  "offer_close_others_copy_email",
  "offer_close_others_copy_linkedin",
  "offer_win_tile_view",
  "offer_win_tile_open_offer_pack",
  "offer_win_tile_log_outcome",
  "offer_win_tile_step_click",
  "offer_win_tile_dismiss",
  "offer_closeout_view",
  "offer_closeout_dismiss",
  "offer_closeout_select_app",
  "offer_closeout_select_all",
  "offer_closeout_mark_closed",
  "offer_closeout_mark_closed_batch",
  "offer_closeout_undo_batch",
  "offer_withdrawal_variant_change",
  "offer_withdrawal_send_gmail",
  "offer_withdrawal_send_linkedin",
  "offer_withdrawal_copy",
  "offer_withdrawal_send_failed",
  "offer_withdrawal_contact_missing",
  "offer_closeout_outcome_logged",
  "offer_closeout_outcome_failed",
  "ops_credit_adjust_view",
  "ops_credit_adjust_submit",
  "ops_credit_adjust_success",
  "ops_credit_adjust_failed",
  "ops_support_link_generate",
  "ops_support_link_copy",
  "followups_strip_view",
  "followups_strip_send_click",
  "followup_modal_view",
  "followup_modal_copy",
  "followup_modal_gmail_open",
  "followup_modal_linkedin_open",
  "followup_modal_log_sent",
  "followup_modal_schedule_next",
  "followup_modal_save_success",
  "followup_modal_save_fail",
  "outreach_recovery_view",
  "outreach_recovery_send",
  "compare_view",
  "compare_reco_view",
  "compare_reco_click",
  "compare_option_switch",
  "compare_why_open",
  "compare_checkout_start",
  "compare_checkout_fail",
  "compare_portal_open",
  "outcome_quicklog_open",
  "outcome_quicklog_save_success",
  "outcome_quicklog_save_fail",
  "outcome_insights_view",
  "outcome_nextmove_click",
  "ops_entry_click",
  "ops_access_denied_view",
  "ops_access_denied_copy_snippet",
  "ops_billing_health_view",
  "ops_billing_health_chip_click",
  "ops_billing_trace_view",
  "ops_billing_trace_chip_click",
  "ops_webhook_health_view",
  "ops_webhook_health_chip_click",
  "ops_webhook_queue_view",
  "ops_webhook_queue_filter",
  "ops_webhook_queue_export",
  "ops_webhook_chip_click",
  "ops_webhook_watch_click",
  "ops_webhook_watch_success",
  "ops_webhook_watch_error",
  "ops_webhooks_queue_view",
  "ops_webhooks_queue_filter",
  "ops_webhooks_queue_export",
  "ops_webhooks_queue_empty_view",
  "ops_webhooks_queue_filter_chip_click",
  "ops_webhook_watch_create_click",
  "ops_webhook_watch_created",
  "ops_webhook_watch_create_error",
  "ops_system_status_view",
  "ops_system_status_refresh_click",
  "ops_system_status_link_click",
  "ops_status_rag_view",
  "ops_status_rag_fetch_error",
  "ops_status_rag_action_click",
  "ops_status_rag_drilldown_view",
  "ops_status_rag_signal_click",
  "ops_status_rag_trend_view",
  "ops_status_rag_trend_direction",
  "ops_status_top_repeats_view",
  "ops_status_top_repeats_click",
  "ops_status_top_repeats_watch_click",
  "ops_panel_rate_limited",
  "ops_panel_fetch_error",
  "early_access_block_view",
  "early_access_block_copy",
  "ops_access_view",
  "ops_access_lookup",
  "ops_access_grant",
  "ops_access_revoke",
  "ops_access_error",
  "ops_alerts_view",
  "ops_alerts_refresh_click",
  "ops_alert_action_click",
  "ops_alert_transition",
  "ops_alert_notify_attempt",
  "ops_alert_notify_success",
  "ops_alert_notify_fail",
  "ops_alert_test_fire",
  "ops_access_invite_view",
  "ops_access_invite_grant",
  "ops_access_invite_revoke",
  "ops_access_invite_copy_instructions",
  "early_access_gate_allowed",
  "early_access_gate_blocked",
  "ops_webhook_open_incidents_click",
  "ops_webhook_open_dossier_click",
  "ops_user_billing_trace_view",
  "ops_user_billing_trace_copy",
  "ops_billing_delay_bucket_view",
  "ops_billing_delay_chip_click",
  "ops_billing_related_incidents_click",
  "ops_billing_related_audits_click",
  "ops_resolution_outcome_set",
  "ops_resolution_outcome_set_click",
  "ops_resolution_outcome_set_success",
  "ops_resolution_outcome_set_error",
  "ops_resolution_outcomes_view",
  "ops_resolution_effectiveness_view",
  "ops_resolution_effectiveness_yes_click",
  "ops_resolution_effectiveness_no_click",
  "ops_resolution_effectiveness_later_click",
  "ops_resolution_effectiveness_save_success",
  "ops_resolution_effectiveness_save_error",
  "ops_resolution_summary_view",
  "ops_resolution_summary_filter_change",
  "ops_resolution_export_click",
  "ops_resolutions_due_view",
  "ops_resolutions_insights_view",
  "ops_watch_add_click",
  "ops_watch_add_success",
  "ops_watch_add_error",
  "ops_watchlist_view",
  "ops_playbook_suppressed_view",
  "ops_billing_playbook_suppressed_success",
  "ops_billing_playbook_unsuppressed_failed",
  "ops_resolution_view",
  "ops_resolution_link_click",
  "ops_resolution_copy_reply",
  "ops_resolution_regenerate",
  "ops_resolution_mark_used",
  "ops_resolution_copy_snippet",
  "ops_billing_resolution_view",
  "ops_billing_resolution_recheck_click",
  "ops_billing_resolution_rate_limited",
  "ops_billing_resolution_mark_resolved",
  "ops_billing_reply_generate_view",
  "ops_billing_reply_copy_subject",
  "ops_billing_reply_copy_body",
  "ops_billing_reply_copy_checklist",
  "ops_billing_snapshot_view",
  "ops_billing_snapshot_refresh_click",
  "ops_billing_snapshot_refresh_ok",
  "ops_billing_snapshot_refresh_error",
  "ops_billing_triage_open_billing_click",
  "ops_billing_triage_open_portal_click",
  "ops_billing_triage_open_dashboard_click",
  "ops_action_rate_limited",
  "system_status_limits_view",
] as const;

const bodySchema = z.object({
  event: z.enum(allowedEvents),
  surface: z.string().optional(),
  applicationId: z.string().uuid().optional(),
  meta: z.record(z.string(), z.any()).optional(),
});

export async function POST(request: Request) {
  const { headers, requestId } = withRequestIdHeaders(request.headers, undefined, { noStore: true });
  const ip = (request.headers.get("x-forwarded-for") ?? request.headers.get("x-real-ip") ?? "").split(",")[0]?.trim() || null;
  const supabase = createServerClient();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return NextResponse.json({ ok: false, error: { code: "UNAUTHORIZED", message: "Unauthorized", requestId } }, { headers, status: 401 });
  }

  const body = (await request.json().catch(() => ({}))) as unknown;
  const parsed = bodySchema.safeParse(body as Record<string, unknown>);
  if (!parsed.success) {
    return NextResponse.json({ ok: false, error: { code: "VALIDATION_FAIL", message: "Invalid payload", requestId } }, { headers, status: 200 });
  }

  const isOps = parsed.data.event.startsWith("ops_") || (parsed.data.surface ?? "").includes("ops");
  const budget = getRateLimitBudget("monetisation_log");
  const limiter = checkRateLimit({
    route: "monetisation_log",
    identifier: user.id ?? ip,
    limit: isOps ? budget.limit * 2 : budget.limit,
    windowMs: budget.windowMs,
    category: isOps ? "ops_action" : "monetisation",
  });
  if (!limiter.allowed) {
    const res = jsonError({
      code: "RATE_LIMITED",
      message: "Too many events. Please slow down.",
      requestId,
      status: 429,
      meta: { limitKey: "monetisation_log", budget: budget.budget, retryAfterSeconds: limiter.retryAfterSeconds },
    });
    return applyRequestIdHeaders(res, requestId, { noStore: true, retryAfterSeconds: limiter.retryAfterSeconds });
  }

  return processMonetisationLog({ supabase, userId: user.id, parsed: parsed.data, requestId, headers });
}
